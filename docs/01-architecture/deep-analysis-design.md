# Deep Analysis 设计文档

## 核心目标

1. **寻找最优秀的玩家体验** - 量化评估关卡质量
2. **AI 辅助制作关卡** - 为 AI 提供明确的优化目标和调整依据

---

## UI 设计

```
[Analysis]  ☐ Deep (~30s)
```

| 设计点 | 决策 |
|--------|------|
| 按钮形式 | 单按钮 + Deep 复选框 |
| 时间提示 | 显示预估时间 `(~30s)` |
| 默认状态 | 不勾选 |
| 状态持久化 | 不持久化，每次打开编辑器重置 |

**设计理由：**
- Deep Analysis 用于定稿前验证，频率较低
- 默认不勾选避免策划前期频繁使用（耗时长）
- 符合"渐进式披露"原则，强调快速分析是主流程

---

## Deep Analysis 输出指标

### 指标总览

| 指标 | 作用 | AI 可用性 |
|------|------|----------|
| 心流曲线 | 体验节奏是否好 | ✓ |
| 分层胜率 | 各层玩家难度是否合适 | ✓✓✓ |
| 瓶颈目标 | 哪个目标导致失败 | ✓✓✓ |
| 技能敏感度 | 技能关 vs 运气关 | ✓✓ |
| 挫败风险 | 连败概率是否过高 | ✓ |
| 运气依赖度 | 随机性是否过大 | ✓✓ |
| P95 通关次数 | 最不幸玩家的体验 | ✓✓ |

### 指标详细说明

#### 1. 心流曲线

评估每一步的"爽感"，绘制曲线图展示体验节奏。

**加权公式：**
```
每步爽感 = 目标进度贡献 × 1.0    // 基准，核心反馈
         + 炸弹形成数 × 0.5      // 有期待感，但还没爆
         + 炸弹激活数 × 0.8      // 视觉爽快
         + 连锁深度 × 0.3        // 递增惊喜
         + 障碍清除数 × 0.4      // 推进感但弱于目标
```

**展示方式：**
- SVG 折线图
- 原始分，Y 轴自适应
- 可加平均线作为参考

**理想曲线特征：**
- 波动上升，有高潮有缓冲
- 无连续 3 步以上的低谷

#### 2. 分层胜率

不同技能水平玩家的胜率分布。

| 玩家类型 | 说明 |
|----------|------|
| 新手 (Novice) | 随机性高，不关注目标和连锁 |
| 休闲 (Casual) | 有基本策略，偶尔犯错 |
| 核心 (Core) | 策略较好，关注目标 |
| 高手 (Expert) | 接近最优决策 |

**用途：** AI 可根据分层胜率调整关卡难度

#### 3. 瓶颈目标

识别哪个目标最常导致关卡失败。

**计算方式：** 统计失败局中，哪个目标的未完成比例最高

**用途：** 告诉 AI 应该调整哪个目标的数量

#### 4. 技能敏感度

衡量技能对胜率的影响程度。

```
技能敏感度 = (高手胜率 - 新手胜率) / 高手胜率
```

- 高：技能关，高手明显优势
- 低：运气关，技能影响小

#### 5. 挫败风险

连续失败的概率。

```
挫败风险 = P(连续失败 ≥ 3 局)
```

**阈值建议：** < 15% 为可接受范围

#### 6. 运气依赖度

关卡结果受随机性影响的程度。

```
运气依赖度 = 局间方差 / 总方差
```

- 0% = 纯技能关
- 100% = 纯运气关
- **理想范围：20-40%**

#### 7. P95 通关次数

95% 玩家能在多少次尝试内通关。

**用途：** 评估"最不幸玩家"的体验，避免设计出让部分玩家几十次都过不了的关卡

---

## 指标体系应用场景

### 关卡评估

单个关卡的质量判断：
- "这关运气依赖度太高（60%），需要降低随机性"
- "瓶颈目标是冰块，考虑减少冰块数量"

### 玩法验证

新机制引入前后的对比：
```
引入"冰冻层"机制前后：
- 心流曲线：是否更有节奏感？
- 技能敏感度：是否增加了策略深度？
- 运气依赖度：是否变得更不可控？
```

### 设计标准

建立量化的"好关卡"定义：
```
"标准休闲关"指标范围：
- 休闲玩家胜率：65-75%
- 运气依赖度：25-35%
- P95 通关次数：≤ 5
- 心流曲线：无连续 3 步低谷
```

### AI 优化目标

为 AI 自动调整关卡提供明确方向：
```
分析结果 → 问题定位 → AI 调整 → 再分析
例：胜率低 + 瓶颈是目标A → 降低目标A数量
```

---

## 指标解读指南

### 健康范围参考

| 指标 | 理想范围 | 警告范围 | 危险范围 |
|------|----------|----------|----------|
| 休闲玩家胜率 | 60-80% | 40-60% / 80-95% | <40% / >95% |
| 死锁率 | <5% | 5-15% | >15% |
| 技能敏感度 | 30-60% | 20-30% / 60-80% | <20% / >80% |
| 挫败风险 | <15% | 15-25% | >25% |
| 运气依赖度 | 25-40% | 15-25% / 40-60% | <15% / >60% |
| P95 通关次数 | 1-5 | 5-8 | >8 |

### 心流曲线解读

| 特征 | 评价 | 建议 |
|------|------|------|
| 平稳向上 | 好 | 节奏渐进，体验流畅 |
| 波动明显但无长低谷 | 好 | 有高潮有喘息 |
| 连续 3+ 步低谷 | 差 | 中间有无聊段，考虑调整 |
| 开局即高潮 | 差 | 后续易疲劳，调整节奏 |
| 全程平直 | 一般 | 缺少惊喜感 |

### 问题诊断表

| 现象 | 可能原因 | 调整方向 |
|------|----------|----------|
| 胜率低 + 瓶颈明确 | 某目标过难 | 降低该目标数量 |
| 胜率低 + 无明显瓶颈 | 步数不足 | 增加步数限制 |
| 技能敏感度过低 | 随机性过大 | 减少随机障碍 |
| 运气依赖度过高 | 缺少策略空间 | 增加可控元素 |
| P95 过高 | 极端运气影响大 | 增加保底机制 |

---

## 数据存储

### 存储结构

分析结果独立存储，不混入关卡配置文件。

```
data/levels/
├── Level1.json           # 关卡配置
├── Level1.analysis.json  # 分析快照 (独立文件)
├── Level2.json
└── Level2.analysis.json
```

### 文件格式

```json
{
  "version": 1,
  "analyzedAt": "2026-01-20T14:30:00Z",
  "levelFileName": "Level1.json",
  "basic": {
    "totalSimulations": 500,
    "winRate": 0.72,
    "deadlockRate": 0.03,
    "difficultyRating": "Medium"
  },
  "deep": {
    "flowCurve": [10, 25, 15, 40, 30, ...],
    "flowMin": 5,
    "flowMax": 50,
    "flowAverage": 25,
    "tierWinRates": {
      "Novice": 0.45,
      "Casual": 0.72,
      "Core": 0.85,
      "Expert": 0.92
    },
    "skillSensitivity": 0.51,
    "frustrationRisk": 0.08,
    "luckDependency": 0.32,
    "p95ClearAttempts": 3
  }
}
```

### 加载逻辑

1. 加载关卡时自动尝试读取对应的 `.analysis.json`
2. 文件不存在 → 显示"未分析"
3. 文件存在 → 显示缓存数据，用户可手动重新分析

---

## 实现备注

- Quick Analysis：使用已优化的快速方案，产出简单数据
- Deep Analysis：更复杂的玩家体验分析，耗时较长
- 两者关系：递进，Deep 结果包含 Quick 且准确性更高

### 相关文件

| 文件 | 说明 |
|------|------|
| `Match3.Core/Analysis/DeepAnalysisService.cs` | Deep 分析核心服务 |
| `Match3.Core/Analysis/DeepAnalysisResult.cs` | Deep 分析结果类型 |
| `Match3.Core/Analysis/LevelAnalysisSnapshot.cs` | 持久化快照结构 |
| `Match3.Web/.../EditorCanvas.razor` | UI 展示面板 |
| `Match3.Web/.../FlowCurveSvg.razor` | 心流曲线 SVG 组件 |
