@using Match3.Web.Services
@using Match3.Editor.Interfaces
@using Match3.Core.Config
@inject Match3GameService GameService
@inject ScenarioLibraryService ScenarioService
@inject IJsonService JsonService
@implements IDisposable

<div class="controls">
    <div class="mb-3">
        <label class="form-label fw-bold text-secondary small">SCENARIOS</label>
        <select class="form-select" @onchange="OnScenarioChanged">
            <option value="">Random Level</option>
            @foreach (var scenario in Scenarios)
            {
                <option value="@scenario.RelativePath">@scenario.Name</option>
            }
        </select>
    </div>

    <button @onclick="ResetGame" class="btn-reset">New Game</button>
    <button @onclick="ToggleAutoPlay" class="btn-reset" style="margin-left: 10px; background-color: #3b82f6;">
        @(GameService.IsAutoPlaying ? "Stop Auto" : "Auto Play")
    </button>
    <div style="margin-top: 15px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
        <label for="speedSlider" style="font-weight: 600; color: #4b5563;">Game Speed: @GameService.GameSpeed.ToString("0.0")x</label>
        <input id="speedSlider" type="range" min="0.1" max="5.0" step="0.1" @bind="GameService.GameSpeed" @bind:event="oninput" style="width: 200px; cursor: pointer;" />
    </div>
</div>

@code {
    private List<Match3.Editor.ViewModels.ScenarioFileEntry> Scenarios = new();
    private string SelectedScenarioPath = "";

    protected override void OnInitialized()
    {
        GameService.OnChange += StateHasChanged;
        LoadScenarios();
    }

    private void LoadScenarios()
    {
        // Load all scenarios flattened
        Scenarios = ScenarioService.SearchFiles("").OrderBy(s => s.Name).ToList();
    }

    private void OnScenarioChanged(ChangeEventArgs e)
    {
        SelectedScenarioPath = e.Value?.ToString() ?? "";
    }

    public void Dispose()
    {
        GameService.OnChange -= StateHasChanged;
    }

    private void ResetGame()
    {
        LevelConfig? config = null;
        if (!string.IsNullOrEmpty(SelectedScenarioPath))
        {
            try
            {
                var json = ScenarioService.ReadScenarioJson(SelectedScenarioPath);
                // Try to parse as ScenarioConfig first, if fails or no Operations, treat as LevelConfig?
                // Actually the files are likely ScenarioConfig JSONs.
                // But Match3GameService.StartNewGame expects LevelConfig.
                // We need to extract InitialState from ScenarioConfig.
                
                // Assuming the JSON structure matches ScenarioConfig or LevelConfig
                // Let's try to parse as ScenarioConfig first
                if (json.Contains("Operations"))
                {
                    var scenario = JsonService.Deserialize<ScenarioConfig>(json);
                    config = scenario.InitialState;
                }
                else
                {
                    // Fallback or direct LevelConfig
                     config = JsonService.Deserialize<LevelConfig>(json);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to load scenario: {ex.Message}");
            }
        }
        
        GameService.StartNewGame(config);
    }
    
    private void ToggleAutoPlay() => GameService.ToggleAutoPlay();
}
