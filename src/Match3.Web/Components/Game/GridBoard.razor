@using Match3.Core
@using Match3.Core.Models.Grid
@using Match3.Core.Models.Enums
@using Match3.Web.Services
@using System.Numerics

@if (GameService.Engine != null)
{
    <div class="board-wrapper">
        <div class="board-container" 
             style="width: @(GameService.Width * Match3GameService.CellSize)px; height: @(GameService.Height * Match3GameService.CellSize)px;"
             @onpointerup="HandlePointerUp">
            <!-- Background Grid -->
            @for (int y = 0; y < GameService.Height; y++)
            {
                @for (int x = 0; x < GameService.Width; x++)
                {
                    var px = x;
                    var py = y;
                    <div class="cell-bg" 
                         style="left: @(x * Match3GameService.CellSize)px; top: @(y * Match3GameService.CellSize)px;"
                         @onpointerdown="e => HandlePointerDown(e, px, py)"
                         @onpointerup="HandlePointerUp">
                    </div>
                }
            }

            <!-- Active Tiles -->
            @foreach (var tile in GameService.Engine.State.Grid)
            {
                if (tile.Type != TileType.None)
                {
                    var isSelected = GameService.Engine.SelectedPosition.IsValid && 
                                   Math.Abs(tile.Position.X - GameService.Engine.SelectedPosition.X) < 0.1f && 
                                   Math.Abs(tile.Position.Y - GameService.Engine.SelectedPosition.Y) < 0.1f;
                    
                    <div @key="tile.Id" class="tile @(isSelected ? "selected" : "")" 
                         style="transform: translate(@(tile.Position.X * Match3GameService.CellSize)px, @(tile.Position.Y * Match3GameService.CellSize)px);"
                         @onpointerdown="e => HandlePointerDown(e, (int)Math.Round(tile.Position.X), (int)Math.Round(tile.Position.Y))"
                         @onpointerup="HandlePointerUp">
                         <div class="tile-inner">
                            <span class="tile-base">@GetTileBaseIcon(tile)</span>
                            @if (HasBombOverlay(tile))
                            {
                                <span class="tile-overlay">@GetBombOverlayIcon(tile)</span>
                            }
                         </div>
                    </div>
                }
            }
        </div>
    </div>
}
else
{
    <div class="loading">Loading Board...</div>
}
