@page "/level-editor"
@using Match3.Core
@using Match3.Core.Config
@using Match3.Core.Models.Grid
@using Match3.Core.Models.Enums
@using Match3.Core.Scenarios
@using Match3.Core.Interfaces
@using Match3.Editor.Interfaces
@using Match3.Editor.ViewModels
@using Match3.Core.Systems
@using Match3.Web.Services
@inject NavigationManager Navigation
@inject Match3GameService GameService
@inject LevelEditorViewModel VM
@inject ScenarioLibraryService ScenarioService
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Level Editor</PageTitle>

<div class="d-flex flex-column vh-100 overflow-hidden" style="max-height: 100vh;">
    <!-- Header -->
    <header class="navbar navbar-dark bg-dark flex-shrink-0 px-3 py-2 shadow-sm justify-content-between">
        <div class="d-flex align-items-center gap-3">
            <span class="navbar-brand mb-0 h1 fs-5">Level Editor</span>
            
            <div class="btn-group btn-group-sm">
                <button class="btn @(VM.CurrentMode == LevelEditorViewModel.EditorMode.Level ? "btn-light" : "btn-outline-light")" 
                        @onclick="() => VM.SwitchMode(LevelEditorViewModel.EditorMode.Level)">
                    Level Design
                </button>
                <button class="btn @(VM.CurrentMode == LevelEditorViewModel.EditorMode.Scenario ? "btn-light" : "btn-outline-light")" 
                        @onclick="SwitchToScenarioMode">
                    Scenario / Test
                </button>
            </div>
        </div>

        <div class="d-flex gap-2">
            @if (VM.CurrentMode == LevelEditorViewModel.EditorMode.Level)
            {
                <button class="btn btn-sm btn-success" @onclick="PlayLevel">
                    <i class="bi bi-play-fill"></i> Play Level
                </button>
            }
            <button class="btn btn-sm btn-outline-info">AI Critic (TODO)</button>
        </div>
    </header>

    <div class="flex-grow-1 d-flex overflow-hidden">
        <!-- LEFT SIDEBAR: Configuration -->
        <aside class="bg-light border-end d-flex flex-column" style="width: 320px; min-width: 320px; overflow-y: auto;">
            <div class="p-3 border-bottom">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">Grid Settings</h6>
                <div class="row g-2 align-items-end">
                    <div class="col-4">
                        <label class="form-label small mb-1">Width</label>
                        <input type="number" class="form-control form-control-sm" @bind="VM.EditorWidth" min="1" max="12" />
                    </div>
                    <div class="col-4">
                        <label class="form-label small mb-1">Height</label>
                        <input type="number" class="form-control form-control-sm" @bind="VM.EditorHeight" min="1" max="12" />
                    </div>
                    <div class="col-4">
                        <button class="btn btn-sm btn-secondary w-100" @onclick="VM.ResizeGrid">Apply</button>
                    </div>
                </div>
                
                @if (VM.CurrentMode == LevelEditorViewModel.EditorMode.Level)
                {
                    <div class="mt-2">
                        <label class="form-label small mb-1">Move Limit</label>
                        <input type="number" class="form-control form-control-sm" @bind="VM.CurrentLevel.MoveLimit" />
                    </div>
                }
            </div>

            <div class="flex-grow-1 p-3 overflow-auto">
                 @if (VM.CurrentMode == LevelEditorViewModel.EditorMode.Level)
                {
                    <h6 class="text-uppercase text-muted small fw-bold mb-2">Level Info</h6>
                     <button class="btn btn-sm btn-outline-secondary w-100 mb-2" @onclick="VM.GenerateRandomLevel">
                        <i class="bi bi-shuffle"></i> Randomize
                    </button>
                }
                else
                {
                    <!-- Scenario Settings -->
                    <div class="mb-3 border-bottom pb-3">
                        <h6 class="text-uppercase text-muted small fw-bold mb-2">Scenario Info</h6>
                        <label class="form-label small mb-1">Name</label>
                        <input type="text" class="form-control form-control-sm mb-2" @bind="VM.ScenarioName" @bind:event="oninput" />
                        
                        <label class="form-label small mb-1">Description</label>
                        <textarea class="form-control form-control-sm mb-2" rows="2" @bind="VM.ScenarioDescription" @bind:event="oninput"></textarea>
                    </div>

                    <!-- File Browser -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-uppercase text-muted small fw-bold mb-0">Scenarios</h6>
                            <button class="btn btn-sm btn-link p-0 text-decoration-none" @onclick="RefreshScenarioList">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        
                        <div class="border rounded bg-white overflow-auto" style="height: 200px;">
                            @if (VM.RootFolderNode != null)
                            {
                                <ScenarioTreeItem Folder="VM.RootFolderNode" 
                                                  CurrentFilePath="@VM.CurrentFilePath"
                                                  ExpandedPaths="VM.ExpandedPaths"
                                                  OnSelectFile="OnSelectScenarioFile"
                                                  OnOpenFile="OnOpenScenarioFile"
                                                  OnContextMenuAction="OnContextMenuAction" />
                            }
                            else
                            {
                                <div class="p-3 text-center text-muted small">Loading...</div>
                            }
                        </div>
                    </div>
                    
                    @if (ShowContextMenu)
                    {
                        <div class="position-fixed top-0 start-0 w-100 h-100" style="z-index: 2000; background: rgba(0,0,0,0.1);" @onclick="CloseContextMenu" @oncontextmenu="CloseContextMenu" @oncontextmenu:preventDefault="true"></div>
                        <div class="position-fixed bg-white shadow-lg rounded border p-2" 
                             style="z-index: 2001; left: @(ContextMenuX)px; top: @(ContextMenuY)px; min-width: 150px;">
                            <h6 class="dropdown-header small text-truncate">@ContextMenuTargetName</h6>
                            @if (ContextMenuType == "folder")
                            {
                                <button class="btn btn-sm btn-light w-100 text-start mb-1" @onclick="CreateNewScenario">
                                    <i class="bi bi-file-earmark-plus me-2"></i> New Scenario
                                </button>
                                <button class="btn btn-sm btn-light w-100 text-start" @onclick="CreateNewFolder">
                                    <i class="bi bi-folder-plus me-2"></i> New Folder
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-light w-100 text-start mb-1" @onclick="DuplicateScenario">
                                    <i class="bi bi-files me-2"></i> Duplicate
                                </button>
                                <hr class="dropdown-divider my-1">
                                <button class="btn btn-sm btn-danger w-100 text-start" @onclick="DeleteFile">
                                    <i class="bi bi-trash me-2"></i> Delete
                                </button>
                            }
                        </div>
                    }

                    <h6 class="text-uppercase text-muted small fw-bold mb-2">Recording</h6>
                    @if (!VM.IsRecording)
                    {
                        <button class="btn btn-success btn-sm w-100 mb-2" @onclick="VM.StartRecording">
                            <i class="bi bi-record-circle"></i> Start Recording
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-danger btn-sm w-100 mb-2" @onclick="VM.StopRecording">
                            <i class="bi bi-stop-circle"></i> Stop Recording
                        </button>
                        <div class="alert alert-info py-1 px-2 small mb-2 text-center">
                            Recording... Click grid to swap.
                        </div>
                    }
                    
                    <div class="border rounded bg-white p-2 mb-3" style="height: 150px; overflow-y: auto;">
                        <div class="small text-muted mb-1">Moves: @VM.CurrentScenario.Operations.Count</div>
                        <ul class="list-unstyled small mb-0 font-monospace">
                            @foreach (var move in VM.CurrentScenario.Operations)
                            {
                                <li>(@move.FromX, @move.FromY) &rarr; (@move.ToX, @move.ToY)</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </aside>

        <!-- CENTER: Canvas -->
        <main class="flex-grow-1 bg-secondary bg-opacity-10 d-flex flex-column position-relative overflow-hidden">
            <!-- Toolbar Overlay -->
            <div class="position-absolute top-0 start-50 translate-middle-x mt-3 bg-white shadow-sm rounded-pill px-3 py-1 d-flex gap-3 align-items-center z-index-10 border" style="z-index: 100;">
                <div class="small fw-bold text-muted">
                    @if(VM.IsRecording) { <span>üî¥ RECORDING</span> }
                    else if(VM.IsAssertionMode) { <span>üéØ VERIFYING</span> }
                    else { <span>‚úèÔ∏è EDITING</span> }
                </div>
                <div class="vr"></div>
                <div class="small text-muted">@VM.ActiveLevelConfig.Width x @VM.ActiveLevelConfig.Height</div>
            </div>

            <!-- Grid Container -->
            <div class="flex-grow-1 d-flex align-items-center justify-content-center overflow-auto p-5">
                @{
                    var currentConfig = VM.ActiveLevelConfig;
                    var width = currentConfig.Width;
                    var height = currentConfig.Height;
                    var tileSize = 60;
                }
                <div class="position-relative shadow-lg bg-white" 
                     style="width: @(width * tileSize)px; height: @(height * tileSize)px; border: 10px solid #fff; border-radius: 4px;"
                     @onmouseleave="StopDrawing"
                     @onmouseup="StopDrawing">
                    
                    @for (int i = 0; i < currentConfig.Grid.Length; i++)
                    {
                        var index = i;
                        var x = i % width;
                        var y = i / width;
                        var displayType = GetTileType(index);
                        var displayBomb = GetBomb(index);
                        var isSelected = VM.IsRecording && VM.SimulationController?.SelectedPosition == new Position(x, y);

                        <div class="position-absolute border border-light" 
                             style="left: @(x * tileSize)px; top: @(y * tileSize)px; width: @(tileSize)px; height: @(tileSize)px; background-color: @GetColor(displayType); cursor: pointer; transition: transform 0.1s;"
                             @onmousedown="() => HandleGridClick(index)"
                             @onmouseenter="() => PaintTile(index)"
                             @ondragstart:preventDefault="true">
                             
                             @if (isSelected)
                             {
                                 <div class="position-absolute top-0 start-0 w-100 h-100 border border-3 border-white shadow-sm" style="z-index: 5;"></div>
                             }
                             
                            <div class="w-100 h-100 d-flex align-items-center justify-content-center" style="pointer-events: none;">
                            </div>
                            
                            @if (displayBomb != BombType.None)
                            {
                                <div class="position-absolute top-50 start-50 translate-middle fs-4" style="pointer-events:none; text-shadow: 0 0 5px rgba(255,255,255,0.8);">
                                    @GetBombIcon(displayBomb)
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </main>

        <!-- RIGHT SIDEBAR: Tools -->
        <aside class="bg-light border-start d-flex flex-column" style="width: 280px; min-width: 280px; overflow-y: auto;">
            <div class="p-3 border-bottom">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">Palette</h6>
                <div class="d-grid gap-2" style="grid-template-columns: repeat(4, 1fr);">
                    @foreach (var type in Enum.GetValues<TileType>())
                    {
                        <button class="btn p-0 border position-relative @(VM.SelectedType == type ? "border-primary border-3" : "")" 
                                style="height: 48px; background-color: @GetColor(type); box-shadow: @(VM.SelectedType == type ? "inset 0 0 0 1px rgba(255,255,255,0.5)" : "none")"
                                @onclick="() => VM.SelectedType = type"
                                title="@type"
                                disabled="@(VM.IsRecording && !VM.IsAssertionMode)">
                            @if (VM.SelectedType == type) { <span class="position-absolute top-50 start-50 translate-middle text-white small">‚úì</span> }
                        </button>
                    }
                </div>
            </div>

            <div class="p-3 border-bottom">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">Items / Bombs</h6>
                <div class="d-grid gap-2" style="grid-template-columns: repeat(3, 1fr);">
                    @foreach (var bomb in (BombType[])Enum.GetValues(typeof(BombType)))
                    {
                        <button class="btn btn-outline-secondary p-1 d-flex flex-column align-items-center justify-content-center @(VM.SelectedBomb == bomb ? "active" : "")" 
                                style="height: 60px;"
                                @onclick="() => VM.SelectedBomb = bomb"
                                title="@bomb"
                                disabled="@(VM.IsRecording && !VM.IsAssertionMode)">
                            <span class="fs-4">@GetBombIcon(bomb)</span>
                            <span style="font-size: 10px;">@bomb</span>
                        </button>
                    }
                </div>
            </div>

            <div class="flex-grow-1 p-3">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">Data IO</h6>
                
                <div class="btn-group w-100 mb-2">
                    <button class="btn btn-primary btn-sm" @onclick="SaveScenario" disabled="@string.IsNullOrEmpty(VM.CurrentFilePath)">
                        <i class="bi bi-save"></i> Save
                    </button>
                    <button class="btn btn-success btn-sm" @onclick="VM.ExportJson">Export</button>
                    <button class="btn btn-warning btn-sm" @onclick="() => VM.ImportJson()">Import</button>
                </div>
                
                <textarea class="form-control form-control-sm font-monospace small" rows="8" @bind="VM.JsonOutput" style="white-space: pre; overflow-x: auto;"></textarea>
            </div>
        </aside>
    </div>
</div>

@code {
    private bool IsDrawing { get; set; } = false;
    private System.Threading.Timer? _timer;

    protected override void OnInitialized()
    {
        VM.OnRequestRepaint += RequestUpdate;
        _timer = new System.Threading.Timer(OnTimerTick, null, 16, 16);
    }

    private void OnTimerTick(object? state)
    {
        if (VM.IsRecording)
        {
            VM.UpdateSimulation(0.016f);
        }
    }

    private void SwitchToScenarioMode()
    {
        VM.SwitchMode(LevelEditorViewModel.EditorMode.Scenario);
        RefreshScenarioList();
    }
    
    private void RefreshScenarioList()
    {
        var root = ScenarioService.BuildTree();
        VM.SetRootFolder(root);
    }

    [Inject] private IPlatformService Platform { get; set; } = default!;

    private void OnSelectScenarioFile(string path)
    {
        // Only select, don't load content
        VM.CurrentFilePath = path;
    }

    private async Task OnOpenScenarioFile(string path)
    {
        if (VM.IsDirty)
        {
            var confirm = await Platform.ConfirmAsync("Unsaved Changes", "You have unsaved changes. Do you want to save them before switching?");
            if (confirm)
            {
                if (!string.IsNullOrEmpty(VM.CurrentFilePath))
                {
                     try 
                     {
                        VM.ExportJson();
                        ScenarioService.WriteScenarioJson(VM.CurrentFilePath, VM.JsonOutput);
                        VM.IsDirty = false;
                     } 
                     catch (Exception ex)
                     {
                        Console.WriteLine("Save failed: " + ex.Message);
                        await Platform.ShowAlertAsync("Save Failed", "Could not save file: " + ex.Message);
                        return; // Stop if save failed
                     }
                }
            }
            else
            {
                // User said No. Check if they want to Discard or Cancel.
                var discard = await Platform.ConfirmAsync("Discard Changes?", "Are you sure you want to discard unsaved changes?");
                if (!discard) return; // Abort switch
            }
        }

        try 
        {
            var json = ScenarioService.ReadScenarioJson(path);
            VM.JsonOutput = json;
            VM.ImportJson(keepScenarioMode: true); 
            VM.CurrentFilePath = path;
            VM.SetScenarioName(Path.GetFileNameWithoutExtension(path));
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error loading scenario: {ex.Message}");
            await Platform.ShowAlertAsync("Error", "Failed to load file: " + ex.Message);
        }
    }

    // --- Context Menu Logic ---
    private bool ShowContextMenu = false;
    private double ContextMenuX = 0;
    private double ContextMenuY = 0;
    private string ContextMenuType = "";
    private string ContextMenuPath = "";
    private string ContextMenuTargetName => Path.GetFileName(ContextMenuPath);

    private void OnContextMenuAction((MouseEventArgs e, string type, string path) args)
    {
        ContextMenuType = args.type;
        ContextMenuPath = args.path;
        
        // If MouseEventArgs is present (desktop right click), use it
        // If triggered by "..." button, we might need to adjust position manually or center it
        if (args.e != null)
        {
            ContextMenuX = args.e.ClientX;
            ContextMenuY = args.e.ClientY;
        }
        else
        {
            // Fallback for non-mouse trigger (should not happen with click event, but just in case)
            ContextMenuX = 100; 
            ContextMenuY = 100;
        }

        // Adjust bounds (simplified)
        if (ContextMenuX > 1000) ContextMenuX = 800; // naive clamp
        
        ShowContextMenu = true;
    }

    private void CloseContextMenu()
    {
        ShowContextMenu = false;
    }

    private async Task CreateNewScenario()
    {
        CloseContextMenu();
        try 
        {
            var newPath = ScenarioService.CreateNewScenario(ContextMenuPath, "New Scenario", "{}");
            RefreshScenarioList();
            // Optionally auto-select
        }
        catch(Exception ex) 
        { 
            Console.WriteLine(ex.Message);
            await Platform.ShowAlertAsync("Error", "Failed to create scenario: " + ex.Message);
        }
    }

    private async Task CreateNewFolder()
    {
        CloseContextMenu();
        try 
        {
            ScenarioService.CreateFolder(ContextMenuPath, "New Folder");
            RefreshScenarioList();
        }
        catch(Exception ex) 
        { 
            Console.WriteLine(ex.Message); 
            await Platform.ShowAlertAsync("Error", "Failed to create folder: " + ex.Message);
        }
    }

    private async Task DuplicateScenario()
    {
        CloseContextMenu();
        try 
        {
            ScenarioService.DuplicateScenario(ContextMenuPath, Path.GetFileNameWithoutExtension(ContextMenuPath) + "_Copy");
            RefreshScenarioList();
        }
        catch(Exception ex) 
        { 
            Console.WriteLine(ex.Message);
            await Platform.ShowAlertAsync("Error", "Failed to duplicate: " + ex.Message);
        }
    }

    private async Task DeleteFile()
    {
        CloseContextMenu();
        
        var confirm = await Platform.ConfirmAsync("Delete", $"Are you sure you want to delete '{ContextMenuTargetName}'?");
        if (!confirm) return;

        try
        {
            if (ContextMenuType == "folder")
            {
                ScenarioService.DeleteFolder(ContextMenuPath);
            }
            else
            {
                ScenarioService.DeleteScenario(ContextMenuPath);
            }
            RefreshScenarioList();
        }
        catch(Exception ex)
        {
            Console.WriteLine(ex.Message);
            await Platform.ShowAlertAsync("Error", "Failed to delete: " + ex.Message);
        }
    }

    private async Task SaveScenario()
    {
        if (string.IsNullOrEmpty(VM.CurrentFilePath)) return;

        try
        {
            var currentName = Path.GetFileNameWithoutExtension(VM.CurrentFilePath);
            if (!string.Equals(currentName, VM.ScenarioName, StringComparison.Ordinal))
            {
                 ScenarioService.RenameScenario(VM.CurrentFilePath, VM.ScenarioName);
                 var dir = Path.GetDirectoryName(VM.CurrentFilePath);
                 var newPath = string.IsNullOrEmpty(dir) 
                     ? VM.ScenarioName + ".json" 
                     : Path.Combine(dir, VM.ScenarioName + ".json");
                 VM.CurrentFilePath = newPath.Replace('\\', '/');
            }

            VM.ExportJson();
            ScenarioService.WriteScenarioJson(VM.CurrentFilePath, VM.JsonOutput);
            VM.IsDirty = false;
            RefreshScenarioList();
        }
        catch (Exception ex)
        {
            await Platform.ShowAlertAsync("Error", "Failed to save: " + ex.Message);
        }
    }

    private void RequestUpdate()
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleGridClick(int index)
    {
        VM.HandleGridClick(index);
    }

    private void StartDrawing(int index)
    {
        if (VM.IsRecording) return;
        IsDrawing = true;
        PaintTile(index);
    }

    private void PaintTile(int index)
    {
        if (IsDrawing && !VM.IsRecording)
        {
            VM.PaintTile(index);
        }
    }

    private void StopDrawing()
    {
        IsDrawing = false;
    }

    private void PlayLevel()
    {
        GameService.StartNewGame(VM.CurrentLevel);
        Navigation.NavigateTo("/");
    }

    private TileType GetTileType(int index)
    {
        if (VM.IsRecording && VM.SimulationController != null)
        {
            var w = VM.ActiveLevelConfig.Width;
            try 
            {
                return VM.SimulationController.State.GetType(index % w, index / w);
            }
            catch { return TileType.None; }
        }
        return VM.ActiveLevelConfig.Grid[index];
    }

    private BombType GetBomb(int index)
    {
        if (VM.IsRecording && VM.SimulationController != null)
        {
            var w = VM.ActiveLevelConfig.Width;
            try
            {
                return VM.SimulationController.State.GetTile(index % w, index / w).Bomb;
            }
            catch { return BombType.None; }
        }
        return index >= 0 && index < VM.ActiveBombs.Length ? VM.ActiveBombs[index] : BombType.None;
    }

    public void Dispose()
    {
        VM.OnRequestRepaint -= RequestUpdate;
        _timer?.Dispose();
    }

    // --- Helpers ---
    private string GetColor(TileType t)
    {
        return t switch
        {
            TileType.Red => "#dc3545",
            TileType.Green => "#198754",
            TileType.Blue => "#0d6efd",
            TileType.Yellow => "#ffc107",
            TileType.Purple => "#6f42c1",
            TileType.Orange => "#fd7e14",
            TileType.Rainbow => "linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet)",
            TileType.None => "#f8f9fa",
            TileType.Bomb => "#dee2e6",
            _ => "#ccc"
        };
    }
    private string GetBombIcon(BombType bomb) => bomb switch
    {
        BombType.None => "",
        BombType.Horizontal => "‚ÜîÔ∏è",
        BombType.Vertical => "‚ÜïÔ∏è",
        BombType.Ufo => "üõ∏",
        BombType.Square3x3 => "üí£",
        BombType.Color => "üåà",
        _ => ""
    };
}
