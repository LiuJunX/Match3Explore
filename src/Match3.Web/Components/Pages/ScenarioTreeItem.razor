@using Match3.Web.Services
@using Match3.Editor.ViewModels
@using System.IO

@* Recursively render folders *@
<div class="scenario-tree-item">
    <div class="d-flex align-items-center py-1 px-2 small tree-node border-bottom @(IsSelected ? "bg-primary text-white" : "hover-bg-light")"
         style="cursor: pointer;"
         @onclick="ToggleExpand"
         @oncontextmenu="OnContextMenu"
         @oncontextmenu:preventDefault="true">
        
        @* Indentation *@
        <div style="width: @(Level * 16)px; flex-shrink: 0;"></div>

        @* Expand/Collapse Icon *@
        <i class="bi @(IsExpanded ? "bi-caret-down-fill" : "bi-caret-right-fill") me-1 text-muted" 
           style="font-size: 0.8em; visibility: @(Folder.Folders.Any() || Folder.Files.Any() ? "visible" : "hidden")"></i>

        @* Folder Icon *@
        <i class="bi bi-folder-fill text-warning me-2"></i>
        
        @* Name *@
        <span class="text-truncate flex-grow-1 user-select-none">@Folder.Name</span>

        @* Action Button *@
        <button class="btn btn-link btn-sm p-0 ms-2 text-muted" 
                style="line-height: 1;"
                @onclick="OnFolderMenu"
                @onclick:stopPropagation="true">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
    </div>

    @if (IsExpanded)
    {
        @foreach (var subFolder in Folder.Folders)
        {
            <ScenarioTreeItem Folder="subFolder" 
                              Level="Level + 1"
                              CurrentFilePath="@CurrentFilePath"
                              ExpandedPaths="ExpandedPaths"
                              OnSelectFile="OnSelectFile"
                              OnOpenFile="OnOpenFile"
                              OnContextMenuAction="OnContextMenuAction" />
        }

        @foreach (var file in Folder.Files)
        {
            var isFileSelected = file.RelativePath == CurrentFilePath;
            <div class="d-flex align-items-center py-1 px-2 small tree-file border-bottom @(isFileSelected ? "bg-primary text-white" : "hover-bg-light")"
                 style="cursor: pointer;"
                 @onclick="() => OnFileClick(file)"
                 @ondblclick="() => OnFileDoubleClick(file)"
                 @oncontextmenu="(e) => OnFileMenu(e, file)"
                 @oncontextmenu:preventDefault="true">
                 
                <!-- Indentation -->
                <div style="width: @((Level + 1) * 16)px; flex-shrink: 0;"></div>

                <!-- File Icon -->
                <i class="bi bi-file-earmark-text me-2 text-secondary @(isFileSelected ? "text-white" : "")"></i>
                
                <!-- Name -->
                <span class="text-truncate flex-grow-1 user-select-none">@file.Name</span>

                <!-- Action Button -->
                <button class="btn btn-link btn-sm p-0 ms-2 @(isFileSelected ? "text-white" : "text-muted")" 
                        style="line-height: 1;"
                        @onclick="(e) => OnFileMenu(e, file)"
                        @onclick:stopPropagation="true">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
            </div>
        }

        @if (!Folder.Folders.Any() && !Folder.Files.Any())
        {
            <div class="text-muted fst-italic py-1 small border-bottom" style="padding-left: @((Level + 1) * 16 + 20)px;">
                (Empty - Right click or use menu to create)
            </div>
        }
    }
</div>

@code {
    [Parameter] public ScenarioFolderNode Folder { get; set; } = null!;
    [Parameter] public int Level { get; set; } = 0;
    [Parameter] public string CurrentFilePath { get; set; } = "";
    [Parameter] public HashSet<string> ExpandedPaths { get; set; } = new();
    [Parameter] public EventCallback<string> OnSelectFile { get; set; }
    [Parameter] public EventCallback<string> OnOpenFile { get; set; }
    [Parameter] public EventCallback<(MouseEventArgs, string, string)> OnContextMenuAction { get; set; }

    private bool IsExpanded => ExpandedPaths.Contains(Folder.RelativePath);
    private bool IsSelected => Folder.RelativePath == CurrentFilePath;

    private void ToggleExpand()
    {
        if (IsExpanded)
            ExpandedPaths.Remove(Folder.RelativePath);
        else
            ExpandedPaths.Add(Folder.RelativePath);
    }

    private async Task OnClick()
    {
        // Select logic
        if (Folder.Files.Any() || Folder.Folders.Any())
        {
             // Folder click logic (maybe toggle expand?)
             ToggleExpand();
        }
        else 
        {
             // File click - just select
             await OnSelectFile.InvokeAsync(Folder.RelativePath);
        }
    }
    
    private async Task OnFileClick(ScenarioFileEntry file)
    {
        await OnSelectFile.InvokeAsync(file.RelativePath);
    }
    
    private async Task OnFileDoubleClick(ScenarioFileEntry file)
    {
        await OnOpenFile.InvokeAsync(file.RelativePath);
    }

    private async Task OnFileMenu(MouseEventArgs e, ScenarioFileEntry file)
    {
        await OnContextMenuAction.InvokeAsync((e, "file", file.RelativePath));
    }

    private async Task OnFolderMenu(MouseEventArgs e)
    {
        await OnContextMenuAction.InvokeAsync((e, "folder", Folder.RelativePath));
    }

    private async Task OnContextMenu(MouseEventArgs e)
    {
        await OnContextMenuAction.InvokeAsync((e, "folder", Folder.RelativePath));
    }
}
