@using Match3.Editor.ViewModels
@using Match3.Editor.Logic
@using Match3.Web.Components.Pages
@inject LevelEditorViewModel VM

<aside class="bg-light border-end d-flex flex-column" style="width: 320px; min-width: 320px; overflow-y: auto;">
    @if (VM.CurrentMode == EditorMode.Scenario)
    {
        <!-- Tab Navigation (Scenario Mode Only) -->
        <ul class="nav nav-tabs nav-fill border-bottom-0 px-2 pt-2" style="background: #e9ecef;">
            <li class="nav-item">
                <button class="nav-link @(VM.ActiveTabIndex == 0 ? "active" : "")" @onclick="() => VM.ActiveTabIndex = 0">
                    <i class="bi bi-grid-3x3"></i> Grid
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(VM.ActiveTabIndex == 1 ? "active" : "")" @onclick="() => VM.ActiveTabIndex = 1">
                    <i class="bi bi-folder"></i> Files
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(VM.ActiveTabIndex == 2 ? "active" : "")" @onclick="() => VM.ActiveTabIndex = 2">
                    <i class="bi bi-check2-square"></i> Test
                </button>
            </li>
        </ul>
    }

    <div class="flex-grow-1 d-flex flex-column overflow-hidden">
        @if (VM.CurrentMode == EditorMode.Level || VM.ActiveTabIndex == 0)
        {
            <!-- Tab: Grid -->
            <div class="p-3 flex-grow-1 overflow-auto">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">Grid Settings</h6>
                <div class="row g-2 align-items-end mb-3">
                    <div class="col-4">
                        <label class="form-label small mb-1">Width</label>
                        <input type="number" class="form-control form-control-sm" @bind="VM.EditorWidth" min="1" max="12" />
                    </div>
                    <div class="col-4">
                        <label class="form-label small mb-1">Height</label>
                        <input type="number" class="form-control form-control-sm" @bind="VM.EditorHeight" min="1" max="12" />
                    </div>
                    <div class="col-4">
                        <button class="btn btn-sm btn-secondary w-100" @onclick="VM.ResizeGrid">Apply</button>
                    </div>
                </div>

                @if (VM.CurrentMode == EditorMode.Level)
                {
                    <div class="mb-3">
                        <label class="form-label small mb-1">Move Limit</label>
                        <input type="number" class="form-control form-control-sm" @bind="VM.CurrentLevel.MoveLimit" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label small mb-1">
                            Difficulty: @(VM.CurrentLevel.TargetDifficulty.ToString("P0"))
                        </label>
                        <input type="range" class="form-range"
                               min="0" max="1" step="0.1"
                               @bind="VM.CurrentLevel.TargetDifficulty"
                               @bind:event="oninput" />
                        <div class="d-flex justify-content-between small text-muted">
                            <span>Easy</span>
                            <span>Hard</span>
                        </div>
                    </div>
                }

                <button class="btn btn-sm btn-outline-secondary w-100" @onclick="VM.GenerateRandomLevel">
                    <i class="bi bi-shuffle"></i> Randomize
                </button>
            </div>
        }
        else if (VM.ActiveTabIndex == 1)
        {
            <!-- Tab: Files (Scenario Info + File Browser) -->
            <div class="p-3 flex-grow-1 overflow-auto d-flex flex-column">
                <div class="mb-3">
                    <h6 class="text-uppercase text-muted small fw-bold mb-2">Scenario Info</h6>
                    <label class="form-label small mb-1">Name</label>
                    <input type="text" class="form-control form-control-sm mb-2" @bind="VM.ScenarioName" @bind:event="oninput" />

                    <label class="form-label small mb-1">Description</label>
                    <textarea class="form-control form-control-sm" rows="2" @bind="VM.ScenarioDescription" @bind:event="oninput"></textarea>
                </div>

                <div class="flex-grow-1 d-flex flex-column min-h-0">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-uppercase text-muted small fw-bold mb-0">Files</h6>
                        <button class="btn btn-sm btn-link p-0 text-decoration-none" @onclick="VM.RefreshScenarioList">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>

                    <div class="border rounded bg-white flex-grow-1 overflow-auto">
                        @if (VM.RootFolderNode != null)
                        {
                            <ScenarioTreeItem Folder="VM.RootFolderNode"
                                              CurrentFilePath="@VM.CurrentFilePath"
                                              ExpandedPaths="VM.ExpandedPaths"
                                              OnSelectFile="OnSelectScenarioFile"
                                              OnOpenFile="OnOpenScenarioFile"
                                              OnContextMenuAction="OnContextMenuAction" />
                        }
                        else
                        {
                            <div class="p-3 text-center text-muted small">Loading...</div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (VM.ActiveTabIndex == 2)
        {
            <!-- Tab: Test (Assertions) -->
            <div class="p-3 flex-grow-1 overflow-auto">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">Assertions</h6>

                @if (!VM.IsAssertionMode)
                {
                    <p class="small text-muted mb-3">
                        Define expected tile states after test execution. Click "Edit" to start placing assertions on the grid.
                    </p>
                    <button class="btn btn-warning btn-sm w-100" @onclick="VM.ToggleAssertionMode">
                        <i class="bi bi-pencil"></i> Edit Assertions
                    </button>
                }
                else
                {
                    <div class="bg-warning bg-opacity-10 p-3 rounded border border-warning mb-3">
                        <div class="small fw-bold text-warning-emphasis mb-2">Editing Mode</div>

                        <div class="form-check form-switch small mb-1">
                            <input class="form-check-input" type="checkbox" id="assertColor" @bind="VM.AssertColor">
                            <label class="form-check-label" for="assertColor">Match Color</label>
                        </div>
                        <div class="form-check form-switch small mb-3">
                            <input class="form-check-input" type="checkbox" id="assertBomb" @bind="VM.AssertBomb">
                            <label class="form-check-label" for="assertBomb">Match Bomb</label>
                        </div>

                        <div class="small text-muted mb-3" style="font-size: 0.75rem;">
                            Select palette items, then click grid cells to set expectations.
                        </div>

                        <button class="btn btn-success btn-sm w-100" @onclick="VM.ToggleAssertionMode">
                            <i class="bi bi-check-lg"></i> Done
                        </button>
                    </div>
                }

                <div class="mt-3">
                    <div class="small text-muted mb-2">
                        Assertions: @VM.CurrentScenario.Assertions.Count
                    </div>
                    @if (VM.CurrentScenario.Assertions.Count > 0)
                    {
                        <div class="border rounded bg-white p-2" style="max-height: 200px; overflow-y: auto;">
                            <ul class="list-unstyled small mb-0 font-monospace">
                                @foreach (var a in VM.CurrentScenario.Assertions)
                                {
                                    <li class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                        <span>(@a.X, @a.Y)</span>
                                        <span class="text-muted">
                                            @(a.Type?.ToString() ?? "*")
                                            @(a.Bomb.HasValue ? GetBombIcon(a.Bomb.Value) : "")
                                        </span>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Context Menu (for file browser) -->
    @if (ShowContextMenu)
    {
        <div class="position-fixed top-0 start-0 w-100 h-100" style="z-index: 2000; background: rgba(0,0,0,0.1);"
             @onclick="CloseContextMenu" @oncontextmenu="CloseContextMenu" @oncontextmenu:preventDefault="true"></div>
        <div class="position-fixed bg-white shadow-lg rounded border p-2"
             style="z-index: 2001; left: @(ContextMenuX)px; top: @(ContextMenuY)px; min-width: 150px;">
            <h6 class="dropdown-header small text-truncate">@ContextMenuTargetName</h6>
            @if (ContextMenuType == "folder")
            {
                <button class="btn btn-sm btn-light w-100 text-start mb-1" @onclick="CreateNewScenario">
                    <i class="bi bi-file-earmark-plus me-2"></i> New Scenario
                </button>
                <button class="btn btn-sm btn-light w-100 text-start" @onclick="CreateNewFolder">
                    <i class="bi bi-folder-plus me-2"></i> New Folder
                </button>
            }
            else
            {
                <button class="btn btn-sm btn-light w-100 text-start mb-1" @onclick="DuplicateScenario">
                    <i class="bi bi-files me-2"></i> Duplicate
                </button>
                <hr class="dropdown-divider my-1">
                <button class="btn btn-sm btn-danger w-100 text-start" @onclick="DeleteFile">
                    <i class="bi bi-trash me-2"></i> Delete
                </button>
            }
        </div>
    }
</aside>

@implements IDisposable

@code {
    protected override void OnInitialized()
    {
        VM.PropertyChanged += OnVmPropertyChanged;
    }

    private void OnVmPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        VM.PropertyChanged -= OnVmPropertyChanged;
    }

    // Context menu state (kept in View for now - UI-only state)
    private bool ShowContextMenu = false;
    private double ContextMenuX = 0;
    private double ContextMenuY = 0;
    private string ContextMenuType = "";
    private string ContextMenuPath = "";
    private string ContextMenuTargetName => System.IO.Path.GetFileName(ContextMenuPath);

    private void OnSelectScenarioFile(string path)
    {
        VM.CurrentFilePath = path;
    }

    private async Task OnOpenScenarioFile(string path)
    {
        await VM.LoadScenarioAsync(path);
    }

    private void OnContextMenuAction((MouseEventArgs e, string type, string path) args)
    {
        ContextMenuType = args.type;
        ContextMenuPath = args.path;

        if (args.e != null)
        {
            ContextMenuX = args.e.ClientX;
            ContextMenuY = args.e.ClientY;
        }
        else
        {
            ContextMenuX = 100;
            ContextMenuY = 100;
        }

        if (ContextMenuX > 1000) ContextMenuX = 800;

        ShowContextMenu = true;
    }

    private void CloseContextMenu()
    {
        ShowContextMenu = false;
    }

    private async Task CreateNewScenario()
    {
        CloseContextMenu();
        await VM.CreateNewScenarioAsync(ContextMenuPath);
    }

    private async Task CreateNewFolder()
    {
        CloseContextMenu();
        await VM.CreateNewFolderAsync(ContextMenuPath);
    }

    private async Task DuplicateScenario()
    {
        CloseContextMenu();
        await VM.DuplicateScenarioAsync(ContextMenuPath);
    }

    private async Task DeleteFile()
    {
        CloseContextMenu();
        await VM.DeleteFileAsync(ContextMenuPath, ContextMenuType == "folder");
    }

    private string GetBombIcon(Match3.Core.Models.Enums.BombType bomb) => bomb switch
    {
        Match3.Core.Models.Enums.BombType.Horizontal => "↔",
        Match3.Core.Models.Enums.BombType.Vertical => "↕",
        Match3.Core.Models.Enums.BombType.Ufo => "U",
        Match3.Core.Models.Enums.BombType.Square5x5 => "S",
        Match3.Core.Models.Enums.BombType.Color => "C",
        _ => ""
    };
}
