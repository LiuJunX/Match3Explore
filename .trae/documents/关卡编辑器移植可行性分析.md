# 重构计划：Level Editor 跨平台架构 (聚焦可移植性)

本计划将通过架构分层实现逻辑与平台的解耦，并建立基于原则的开发规范，确保未来的 Unity 移植顺畅。

## 阶段 0：确立可移植性原则 (Project Rules)
1.  **更新 `.trae/rules/project_rules.md`**
    *   **新增 "Cross-Platform Portability" 原则**：
        *   **No Native IO**: 逻辑层禁止直接使用 `System.IO` 或 `System.Console`。所有副作用必须通过抽象接口。
        *   **No UI Logic**: 逻辑层禁止包含任何 UI 框架特定代码 (Razor/Unity)。UI 必须是 ViewModel 的纯映射。
        *   **Platform Agnostic**: 核心代码必须是纯 .NET Standard，不依赖特定运行时。

## 阶段 1：构建逻辑核心 (Match3.Editor)
1.  **新建 `Match3.Editor` 项目** (.NET Standard 2.1)
    *   这是未来的“通用编辑器内核”，可被 Web 和 Unity 共享。
2.  **定义抽象层 (Abstractions)**
    *   定义 `IPlatformService` (涵盖文件、弹窗、剪贴板等)。
    *   *注：将多个细碎接口合并为一个高层服务接口，降低接入复杂度。*
3.  **迁移核心逻辑**
    *   将 `LevelEditor.razor` 中的业务逻辑（笔刷、生成、数据管理）提取为 `LevelEditorViewModel`。
    *   将逻辑中的 `File.Write` 改写为 `Platform.FileSystem.Write`。
    *   将逻辑中的 `JS.Alert` 改写为 `Platform.UI.Alert`。

## 阶段 2：Web 平台适配 (Match3.Web)
1.  **实现适配层**
    *   实现 `WebPlatformService`，对接 `System.IO` 和 `IJSRuntime`。
2.  **重构 UI**
    *   `LevelEditor.razor` 瘦身：移除所有业务逻辑，仅保留数据绑定和事件转发。
    *   验证：确保重构后的 Web 编辑器功能与重构前完全一致。

## 阶段 3：清理与验证
1.  **依赖检查**：确认 `Match3.Editor` 不引用任何 Web 相关库。
2.  **规则验证**：自我审查代码，确保符合阶段 0 确立的原则。

---
**确认后，我将首先更新项目规则，确立“可移植性优先”的开发基调。**